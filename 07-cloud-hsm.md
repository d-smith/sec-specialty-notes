# Cloud HSM Deep Dive

## Cloud HSM

Review overview and diffs between KMS and Cloud HSM - see part 4 notes.

Create a cluster and HSM:

* create vpc
* create a private and public subnet
* create the cluster
* verify the hsm identity
* initialize the cluster
* launch a client instance
* install and configure the client
* activate the cluster
* setup users
* generate keys

HSM cluster

* create a cluster in a vpc, put in private subnets in at least two availability zones
* after cluster created, initialize the cluster
    * pick an AZ, create
    * download cluster csr, hsm certificate, aws certificate, manufacturer certificate
    * learn more > how to get the root certificates (aws and manufacturer), download and verify

## Cloud HSM - Verifying Our Certs

To initialize your cluster, you sign a certificate signing request (CSR) generated by the cluster's first HSM.

Process documented [here](https://docs.aws.amazon.com/cloudhsm/latest/userguide/verify-hsm-identity.html)

Sign the cluster CSR to initialize the cluster.

## AWS CloudHSM - Initializing Our Cluster

Steps:

* Get the cluster CSR
* Sign the CSR
* Initialize the cluster

Once the cluster is initialized, you manage it via an EC2 instance.

## CloudHSM - Installing and Configuring Our Client

Use an EC2 instance in the private subnet.

* Download and install the software
* Grab the cert used to initialize the cluster
* Configure the client

## CloudHSM - Activating Our Cluster

Activate the cluster using the client software we installed.

Cloud HSM Users - see [here](https://docs.aws.amazon.com/cloudhsm/latest/userguide/hsm-users.html)

* Precrypto Officer (PRECO)
    * Default administrator when we provision our HSM, removed later
* Crypto Officer (PCO and CO)
    * First user, can generate other crypto officers
* Crypto Users (CU)
* Appliance User (AU)

Roles

* Crypto Officer (PCO and CO)
  * Performs user management operations - create and delete users, change user passwords.
  * Can't do anything with keys
* Crypto Users (CU)
  * Key management - create, delete, chare, import, and export crytographic keys
  * Crytographic operations - use keys for encryption, decryption, signing, verifying, and more.
* Appliance User
  * Perform cloning and sync operations.
  * Exists on all HSMs provided by AWS CloudHSM and has limited permissions.


Client - cloudhsm_mgmt_util

* enable_e2e - enable end to end encryption
* listUsers
* loginHSM PRECO admin password 
  * Login as PRECO using default creds - `loginHSM PRECO admin password`
  * CHange PRECO password - PRECO is now a crypto officer - `changePswd PRECO admin <NewPassword>`
* create CO and CU users
  * `createUser <user type> <user name> <password>`

Key Management Utility

* start cloudhsm-client
* /opt/cloudhsm/bin/key_mgmt_util
* loginHSM -u CU -p password -s username

## CloudHSM - Generating and Exporting Our Keys

EC2 instance, copied our self signed cert to it, used the cloud hsm client to connect via the private ip to our cloud hsm...

Commands:

* loginHSM
* genRSAKeyPair
* genSymKey - used as a wrapping key - used to wrap private key
* wrapKey command - wrap your private key with your wrapping key, can only export wrapped keys
* exportPrivateKey
* exportPublicKey

Lab

* copied wrapping, private, and public keys to s3, then downloaded public and private key
* go to ec2, my key pairs, import
  * copy in public key (remove begin and end public key lines), and it MyHSMKeyPair
* Launch an instance using the key pair


## CloudHSM Wrap Up

Process

* Downloaded AWS root cert and Manufacturer root cert
* Provisioned our cluster and installed our first HSM
* Were given certs and a signing request, including the AWS hardware cert and the manufacturer hardware cert
* Then got the HSM certificate and the cluster CSR
* Sign the CSR with our CA
* Verified using chain certificate for both the AWS and manufacturer root certs
* Then took HSM cert and cluster CSR to extract public keys, checked they match
* Initialize cluster with more cert stuff
* Deploy ec2 instance to manage our cluster, download our self signed cert to the instance, installed the tools, provision COs and CUs, etc.

Exam Tips

* Remember the 4 user types (PRECO, CO, CU, AU)
* Main roles - crypto officers (manage users), crypto users (do crypto stuff)


